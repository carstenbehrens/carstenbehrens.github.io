{"hash":"773198708fd83e8935cdc75cdd2e7a0ce53b81c8","data":{"post":{"title":"How to drop all collections in a MongoDB database using Mongoose","date":"August 19, 2020","content":"<p>During testing your API you often want to reset your DB for each test.\nThis was the problem that I was facing.</p>\n<p>I solved this by creating a <strong>reset</strong> endpoint wich drops all collections inside my MongoDB database.</p>\n<p>Code sample is worth a thousand words, so here we go:</p>\n<pre class=\"shiki\" style=\"background-color: #2e3440ff\"><code><span class=\"line\"><span style=\"color: #81A1C1\">const</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #D8DEE9\">mongoose</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #88C0D0\">require</span><span style=\"color: #D8DEE9FF\">(</span><span style=\"color: #ECEFF4\">&quot;</span><span style=\"color: #A3BE8C\">mongoose</span><span style=\"color: #ECEFF4\">&quot;</span><span style=\"color: #D8DEE9FF\">)</span><span style=\"color: #81A1C1\">;</span></span>\n<span class=\"line\"><span style=\"color: #81A1C1\">const</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #D8DEE9\">express</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #88C0D0\">require</span><span style=\"color: #D8DEE9FF\">(</span><span style=\"color: #ECEFF4\">&quot;</span><span style=\"color: #A3BE8C\">express</span><span style=\"color: #ECEFF4\">&quot;</span><span style=\"color: #D8DEE9FF\">)</span><span style=\"color: #81A1C1\">;</span></span>\n<span class=\"line\"><span style=\"color: #81A1C1\">const</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #D8DEE9\">router</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #D8DEE9\">express</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #88C0D0\">Router</span><span style=\"color: #D8DEE9FF\">()</span><span style=\"color: #81A1C1\">;</span></span>\n\n<span class=\"line\"><span style=\"color: #616E88\">// @route GET api/reset</span></span>\n<span class=\"line\"><span style=\"color: #616E88\">// @access Private</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9\">router</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #88C0D0\">delete</span><span style=\"color: #D8DEE9FF\">(</span><span style=\"color: #ECEFF4\">&quot;</span><span style=\"color: #A3BE8C\">/</span><span style=\"color: #ECEFF4\">&quot;</span><span style=\"color: #ECEFF4\">,</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">async</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #D8DEE9\">req</span><span style=\"color: #ECEFF4\">,</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #D8DEE9\">res</span><span style=\"color: #ECEFF4\">)</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">=&gt;</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">{</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">  </span><span style=\"color: #81A1C1\">try</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">{</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #81A1C1\">const</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #D8DEE9\">db</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #D8DEE9\">mongoose</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9\">connection</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9\">db</span><span style=\"color: #81A1C1\">;</span></span>\n\n<span class=\"line\"><span style=\"color: #ECEFF4\">    </span><span style=\"color: #616E88\">// Get all collections</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #81A1C1\">const</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #D8DEE9\">collections</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">await</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #D8DEE9\">db</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #88C0D0\">listCollections</span><span style=\"color: #D8DEE9FF\">()</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #88C0D0\">toArray</span><span style=\"color: #D8DEE9FF\">()</span><span style=\"color: #81A1C1\">;</span></span>\n\n<span class=\"line\"><span style=\"color: #ECEFF4\">    </span><span style=\"color: #616E88\">// Create an array of collection names and drop each collection</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #D8DEE9\">collections</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">      </span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #88C0D0\">map</span><span style=\"color: #D8DEE9FF\">(</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #D8DEE9\">collection</span><span style=\"color: #ECEFF4\">)</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">=&gt;</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #D8DEE9\">collection</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9\">name</span><span style=\"color: #D8DEE9FF\">)</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">      </span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #88C0D0\">forEach</span><span style=\"color: #D8DEE9FF\">(</span><span style=\"color: #81A1C1\">async</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #D8DEE9\">collectionName</span><span style=\"color: #ECEFF4\">)</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">=&gt;</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">{</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">        </span><span style=\"color: #D8DEE9\">db</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #88C0D0\">dropCollection</span><span style=\"color: #D8DEE9FF\">(</span><span style=\"color: #D8DEE9\">collectionName</span><span style=\"color: #D8DEE9FF\">)</span><span style=\"color: #81A1C1\">;</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">      </span><span style=\"color: #ECEFF4\">}</span><span style=\"color: #D8DEE9FF\">)</span><span style=\"color: #81A1C1\">;</span></span>\n\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #D8DEE9\">res</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #88C0D0\">sendStatus</span><span style=\"color: #D8DEE9FF\">(</span><span style=\"color: #B48EAD\">200</span><span style=\"color: #D8DEE9FF\">)</span><span style=\"color: #81A1C1\">;</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">  </span><span style=\"color: #ECEFF4\">}</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">catch</span><span style=\"color: #D8DEE9FF\"> (</span><span style=\"color: #D8DEE9\">e</span><span style=\"color: #D8DEE9FF\">) </span><span style=\"color: #ECEFF4\">{</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #D8DEE9\">console</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #88C0D0\">log</span><span style=\"color: #D8DEE9FF\">(</span><span style=\"color: #D8DEE9\">e</span><span style=\"color: #D8DEE9FF\">)</span><span style=\"color: #81A1C1\">;</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #D8DEE9\">res</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #88C0D0\">sendStatus</span><span style=\"color: #D8DEE9FF\">(</span><span style=\"color: #B48EAD\">500</span><span style=\"color: #D8DEE9FF\">)</span><span style=\"color: #81A1C1\">;</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">  </span><span style=\"color: #ECEFF4\">}</span></span>\n<span class=\"line\"><span style=\"color: #ECEFF4\">}</span><span style=\"color: #D8DEE9FF\">)</span><span style=\"color: #81A1C1\">;</span></span>\n\n<span class=\"line\"><span style=\"color: #8FBCBB\">module</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #8FBCBB\">exports</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #D8DEE9\">router</span><span style=\"color: #81A1C1\">;</span></span></code></pre>\n","tags":[{"title":"JavaScript","path":"/tag/JavaScript/"},{"title":"MongoDB","path":"/tag/MongoDB/"},{"title":"Backend","path":"/tag/Backend/"}]}},"context":{}}